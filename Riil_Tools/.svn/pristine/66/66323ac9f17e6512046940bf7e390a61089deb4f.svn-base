<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.riil.base.policy.impl.dao.RecThresholdDao">
	<resultMap id="RecommandThresholdPojoResultMap" type="com.riil.base.resmodel.pojo.policy.RecommandThresholdPojo">
		<result property="eventName" column="C_EVENT_NAME" javaType="string" jdbcType="VARCHAR" />
		<result property="metricValue" column="C_METRIC_VALUE" javaType="string" jdbcType="VARCHAR" />
		<result property="metricId" column="C_METRIC_ID" javaType="string" jdbcType="VARCHAR" />
		<result property="modelId" column="C_MODEL_ID" javaType="string" jdbcType="VARCHAR" />
		<result property="policyId" column="C_POLICY_ID" javaType="string" jdbcType="VARCHAR" />
		<result property="policyType" column="C_POLICY_TYPE" javaType="string" jdbcType="VARCHAR" />
		<result property="resTypeId" column="c_RES_TYPE_ID" javaType="string" jdbcType="VARCHAR" />
		<result property="treeNodeId" column="C_TREE_NODE_ID" javaType="string" jdbcType="VARCHAR" />
	</resultMap>
	
	<select id="select_data_by_metric_id_policy_id_model_id"  parameterType="java.util.Map"  resultMap="RecommandThresholdPojoResultMap">
		SELECT 
  		  e.C_EVENT_NAME,
		  e.C_METRIC_ID,
		  e.C_POLICY_ID,
		  d.C_METRIC_VALUE * 1 AS C_METRIC_VALUE,
		  p.C_TREE_NODE_ID,
		  p.c_RES_TYPE_ID,
		  p.C_MODEL_ID,
		  p.C_POLICY_TYPE
		FROM
		  t_data_event e 
		  LEFT JOIN t_moni_policy_info p 
		    ON e.C_POLICY_ID = p.C_ID 
		  LEFT JOIN t_data_event_detail d 
		    ON e.C_ID = d.c_data_event_id 
		WHERE e.C_METRIC_ID = #{metricId ,jdbcType=VARCHAR} 
		  AND p.C_ID = #{policyId ,jdbcType=VARCHAR} 
		  AND p.C_MODEL_ID = #{modelId ,jdbcType=VARCHAR} 
		  AND d.C_TASK_TIME &gt;  <include refid="before_today_7d1"/>${metricDate}<include refid="before_today_7d2"/>
		 <if test="startTime != null and startTime != ''  and endTime != null and endTime != '' ">
			AND <include refid="time_format_1"/>d.C_TASK_TIME<include refid="time_format_2"/> BETWEEN #{startTime ,jdbcType=VARCHAR} AND
			#{endTime ,jdbcType=VARCHAR}
            </if>
		  <choose>
		  	<when test="metricId == 'Health'">
		  	<if test="yellow != null and red != null">
				 AND d.C_METRIC_VALUE &lt;= #{yellow ,jdbcType=DOUBLE}  
				 AND d.C_METRIC_VALUE &gt;= #{red ,jdbcType=DOUBLE}  
			  </if>
			  <if test=" red != null  and yellow == null ">
					 AND d.C_METRIC_VALUE  &lt; #{red ,jdbcType=DOUBLE}  
			  </if>
		  	</when>
		  	<otherwise>
		  	 <if test="yellow != null and red != null">
				 AND d.C_METRIC_VALUE  &gt;= #{yellow ,jdbcType=DOUBLE}  
				 AND d.C_METRIC_VALUE &lt;= #{red ,jdbcType=DOUBLE}  
			  </if>
			  <if test=" yellow == null  and red != null ">
					 AND d.C_METRIC_VALUE &gt; #{red ,jdbcType=DOUBLE}  
			  </if>
		  	</otherwise>
		  </choose>
		  
		  UNION
		  
		 SELECT 
  		  e.C_EVENT_NAME,
		  e.C_METRIC_ID,
		  e.C_POLICY_ID,
		  d.C_METRIC_VALUE * 1 AS C_METRIC_VALUE,
		  p.C_TREE_NODE_ID,
		  p.c_RES_TYPE_ID,
		  p.C_MODEL_ID,
		  p.C_POLICY_TYPE
		FROM
		  t_data_event_his e 
		  LEFT JOIN t_moni_policy_info p 
		    ON e.C_POLICY_ID = p.C_ID 
		  LEFT JOIN t_data_event_detail d 
		    ON e.C_ID = d.C_DATA_EVENT_ID 
		WHERE e.C_METRIC_ID = #{metricId ,jdbcType=VARCHAR} 
		  AND p.C_ID = #{policyId ,jdbcType=VARCHAR} 
		  AND p.C_MODEL_ID = #{modelId ,jdbcType=VARCHAR} 
		  AND d.C_TASK_TIME &gt; <include refid="before_today_7d1"/>${metricDate}<include refid="before_today_7d2"/>
		 <if test="startTime != null and startTime != ''  and endTime != null and endTime != '' ">
			AND <include refid="time_format_1"/>d.C_TASK_TIME<include refid="time_format_2"/> BETWEEN #{startTime ,jdbcType=VARCHAR} AND
			#{endTime ,jdbcType=VARCHAR}
            </if>
		 <choose>
		  	<when test="metricId == 'Health'">
		  	<if test="yellow != null and red != null">
				 AND d.C_METRIC_VALUE &lt;= #{yellow ,jdbcType=DOUBLE}  
				 AND d.C_METRIC_VALUE &gt;= #{red ,jdbcType=DOUBLE}  
			  </if>
			  <if test=" red != null  and yellow == null ">
					 AND d.C_METRIC_VALUE  &lt; #{red ,jdbcType=DOUBLE}  
			  </if>
		  	</when>
		  	<otherwise>
		  	 <if test="yellow != null and red != null">
				 AND d.C_METRIC_VALUE  &gt;= #{yellow ,jdbcType=DOUBLE}  
				 AND d.C_METRIC_VALUE &lt;= #{red ,jdbcType=DOUBLE}  
			  </if>
			  <if test=" yellow == null  and red != null ">
					 AND d.C_METRIC_VALUE &gt; #{red ,jdbcType=DOUBLE}  
			  </if>
		  	</otherwise>
		  </choose>
		  ORDER BY C_METRIC_VALUE 
	</select>
</mapper>
