<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.riil.base.policy.impl.dao.PolicyResRelDAO">

	<resultMap id="PolicyResRelResultMap" type="com.riil.base.resmodel.pojo.policy.PolicyResRelPojo">
		<result property="id" column="C_ID" javaType="string" jdbcType="VARCHAR" />
		<result property="instId" column="C_INST_ID" javaType="string" jdbcType="VARCHAR" />
		<result property="isMain" column="C_IS_MAIN" javaType="byte" jdbcType="TINYINT" />
		<result property="policyId" column="C_POLICY_ID" javaType="string" jdbcType="VARCHAR" />
		<result property="subInstId" column="C_SUB_INST_ID" javaType="string" jdbcType="VARCHAR" />
		<result property="tag1" column="C_TAG1" javaType="string" jdbcType="VARCHAR" />
	</resultMap>


	<!-- Select POJO object by unique_index -->
	<sql id="where_unique_index_part">
		WHERE C_POLICY_ID = #{policyId ,jdbcType=VARCHAR}
		AND C_INST_ID = #{instId ,jdbcType=VARCHAR}
		<if test="subInstId != null and subInstId != ''">
			AND C_SUB_INST_ID =#{subInstId ,jdbcType=VARCHAR}
        </if>

	</sql>
	<!-- Insert POJO object -->
<!-- 	<insert id="batchInsert" parameterType="java.util.Map">
		INSERT INTO t_moni_policy_res_rel ( C_ID, C_INST_ID, C_IS_MAIN,
		C_POLICY_ID, C_SUB_INST_ID, C_TAG1 )
		VALUES
		<foreach collection="resRels" item="resRel" separator=",">
			( #{resRel.id}, #{resRel.instId}, #{resRel.isMain},
			#{policyId ,jdbcType=VARCHAR},
			#{resRel.subInstId}, #{resRel.tag1} )
		</foreach>
	</insert> -->
	
	<insert id="insert" parameterType="com.riil.base.resmodel.pojo.policy.PolicyResRelPojo">
		INSERT INTO t_moni_policy_res_rel ( C_ID, C_INST_ID, C_IS_MAIN,
		C_POLICY_ID, C_SUB_INST_ID, C_TAG1 )
		VALUES
			( #{id}, #{instId}, #{isMain},
			#{policyId},
			#{subInstId,jdbcType=VARCHAR}, #{tag1,jdbcType=VARCHAR} )
	</insert>
	
	<insert id="batchInsert" parameterType="list">
		INSERT INTO t_moni_policy_res_rel ( C_ID, C_INST_ID, C_IS_MAIN,
		C_POLICY_ID, C_SUB_INST_ID, C_TAG1 )
		VALUES
		<foreach collection="list" item="resRel" separator=",">
			( #{resRel.id}, #{resRel.instId}, #{resRel.isMain},
			#{resRel.policyId},
			#{resRel.subInstId,jdbcType=VARCHAR}, #{resRel.tag1,jdbcType=VARCHAR} )
		</foreach>
	</insert>

	<!-- Insert POJO object -->
	<insert id="batchInsert_list" parameterType="list">
		INSERT INTO t_moni_policy_res_rel ( C_ID, C_INST_ID, C_IS_MAIN,
		C_POLICY_ID, C_SUB_INST_ID, C_TAG1 )
		VALUES
		<foreach collection="list" item="resRel" separator=",">
			( #{resRel.id}, #{resRel.instId}, #{resRel.isMain},
			#{resRel.policyId}, #{resRel.subInstId,jdbcType=VARCHAR}, #{resRel.tag1,jdbcType=VARCHAR} )
		</foreach>
	</insert>

	<!-- Delete POJO object by ID! -->
<!-- 	<delete id="delete_by_policyId_resInstanceIds" parameterType="java.util.Map"> -->
<!-- 		DELETE FROM t_moni_policy_res_rel WHERE EXISTS -->
<!-- 		(SELECT info.c_id FROM t_moni_policy_info info -->
<!-- 			WHERE -->
<!-- 			((t_moni_policy_res_rel.C_POLICY_ID = #{policyId ,jdbcType=VARCHAR} AND -->
<!-- 			t_moni_policy_res_rel.C_INST_ID IN -->
<!-- 			<foreach item="item" index="index" collection="resList" open="(" separator="," close=")"> -->
<!-- 				#{item} -->
<!-- 	        </foreach> -->
<!-- 			) -->
<!-- 			OR (info.C_MAIN_POLICY_ID = #{policyId ,jdbcType=VARCHAR} AND info.C_ID = t_moni_policy_res_rel.C_POLICY_ID -->
<!-- 			AND t_moni_policy_res_rel.C_INST_ID IN -->
<!-- 			<foreach item="item" index="index" collection="resList" open="(" separator="," close=")"> -->
<!-- 				#{item} -->
<!-- 	        </foreach> -->
<!-- 			)) -->
<!-- 			OR (t_moni_policy_res_rel.C_POLICY_ID = #{policyId ,jdbcType=VARCHAR} AND t_moni_policy_res_rel.C_SUB_INST_ID IN -->
<!-- 			<foreach item="item" index="index" collection="resList" open="(" separator="," close=")"> -->
<!-- 				#{item} -->
<!-- 	        </foreach> -->
<!-- 			) -->
<!-- 		) -->
<!-- 	</delete> -->

	<delete id="delete_by_policyId_resInstanceIds" parameterType="java.util.Map">
		DELETE FROM t_moni_policy_res_rel WHERE t_moni_policy_res_rel.C_POLICY_ID = #{policyId ,jdbcType=VARCHAR} AND
			t_moni_policy_res_rel.C_INST_ID IN
			<foreach item="item" index="index" collection="resList" open="(" separator="," close=")">
				#{item}
	        </foreach>
	</delete>
	
	<delete id="delete_by_policyId_resInstanceIds_relSub" parameterType="java.util.Map">
		DELETE FROM t_moni_policy_res_rel WHERE EXISTS
		(SELECT info.c_id FROM t_moni_policy_info info
			WHERE
			info.C_MAIN_POLICY_ID = #{policyId ,jdbcType=VARCHAR} AND info.C_ID = t_moni_policy_res_rel.C_POLICY_ID
			AND t_moni_policy_res_rel.C_INST_ID IN
			<foreach item="item" index="index" collection="resList" open="(" separator="," close=")">
				#{item}
	        </foreach>
		)
	</delete>

	<delete id="delete_by_policyId_resInstanceIds_4Sub" parameterType="java.util.Map">
		DELETE FROM t_moni_policy_res_rel WHERE t_moni_policy_res_rel.C_POLICY_ID = #{policyId ,jdbcType=VARCHAR} AND t_moni_policy_res_rel.C_SUB_INST_ID IN
			<foreach item="item" index="index" collection="resList" open="(" separator="," close=")">
				#{item}
	        </foreach>
	</delete>

	<!-- Delete POJO object by ID -->
	<delete id="delete_by_policyId" parameterType="string">
		DELETE FROM
		t_moni_policy_res_rel WHERE C_POLICY_ID = #{policyId ,jdbcType=VARCHAR}

	</delete>
	<!-- Delete POJO object by ID -->
	<delete id="delete_by_unique_index" parameterType="com.riil.base.resmodel.pojo.policy.PolicyResRelPojo">
		DELETE FROM t_moni_policy_res_rel
		<include refid="where_unique_index_part" />
	</delete>
	<!-- Delete POJO object by ID -->
	<delete id="batchDeleteByIds" parameterType="java.util.List">
		DELETE FROM t_moni_policy_res_rel WHERE C_POLICY_ID IN
		<foreach item="item" index="index" collection="list" open="(" separator="," close=")">
			#{item}
        </foreach>
	</delete>
	<!-- Delete POJO object by ID - -->
	<delete id="batchDeleteByResIds" parameterType="java.util.Map">
		DELETE FROM t_moni_policy_res_rel
		WHERE EXISTS 
		(
		SELECT i.c_id 
		FROM t_moni_policy_info i WHERE
		i.C_POLICY_TYPE = #{policyType}
		AND i.C_ID =
		t_moni_policy_res_rel.C_POLICY_ID
		AND (t_moni_policy_res_rel.C_INST_ID IN
		<foreach item="item" index="index" collection="resList" open="(" separator="," close=")">
			#{item}
        </foreach>
		OR t_moni_policy_res_rel.C_SUB_INST_ID IN
		<foreach item="item" index="index" collection="resList" open="(" separator="," close=")">
			#{item}
        </foreach>
		)
		)
	</delete>

	<!-- Select POJO object by ID, 虚资源C_IS_MAIN为-2 -->
	<select id="select_by_policyId" parameterType="string" resultMap="PolicyResRelResultMap">
		SELECT C_INST_ID, C_IS_MAIN, C_POLICY_ID,
		C_SUB_INST_ID, C_TAG1
		FROM t_moni_policy_res_rel
		WHERE C_POLICY_ID = #{policyId ,jdbcType=VARCHAR} 
		AND C_IS_MAIN > -2
    </select>
	<select id="select_by_unique_index" parameterType="com.riil.base.resmodel.pojo.policy.PolicyResRelPojo"
		resultMap="PolicyResRelResultMap">
		SELECT c_id, C_INST_ID, C_IS_MAIN, C_POLICY_ID, C_SUB_INST_ID, C_TAG1
		FROM t_moni_policy_res_rel
		<include refid="where_unique_index_part" />
		<include refid="limit_one" />
	</select>
	<!-- Update POJO object policyId by oriPolicyId -->
	<update id="update_newPolicyId_by_oriPolicyId" parameterType="java.util.Map">
		UPDATE t_moni_policy_res_rel
		SET C_POLICY_ID =	#{oriPolicyId}
		WHERE C_POLICY_ID = #{newPolicyId}
    </update>
	<sql id="update_part">
		UPDATE t_moni_policy_res_rel
		<trim prefix="SET" suffixOverrides=",">
			<if test="subInstId != null and subInstId !='' ">
				C_SUB_INST_ID = #{subInstId ,jdbcType=VARCHAR},
        </if>
			<if test="instId != null and instId !='' ">
				C_INST_ID = #{instId ,jdbcType=VARCHAR},
        </if>
			<if test="isMain != null and isMain !='' ">
				C_IS_MAIN = #{isMain ,jdbcType=TINYINT},
        </if>
			<if test="policyId != null and policyId !='' ">
				C_POLICY_ID = #{policyId ,jdbcType=VARCHAR},
        </if>
			<if test="tag1 != null and tag1 !='' ">
				C_TAG1 = #{tag1 ,jdbcType=VARCHAR},
        </if>
		</trim>
	</sql>
	<update id="update_by_unique_index" parameterType="com.riil.base.resmodel.pojo.policy.PolicyResRelPojo">
		<include refid="update_part" />
		<include refid="where_unique_index_part" />
	</update>
	
	
	
	<select id="select_res_ids_by_policy_ids" parameterType="list" resultType="String">
		SELECT distinct C_INST_ID
		FROM t_moni_policy_res_rel
		WHERE C_POLICY_ID IN
		<foreach item="item" index="index" collection="list" open="(" separator="," close=")">
			#{item}
        </foreach>
    </select>
</mapper>
